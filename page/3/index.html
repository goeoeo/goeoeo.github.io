<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="D033aiBRFi">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://phpdi.github.io').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="自律给我自由">
<meta property="og:type" content="website">
<meta property="og:title" content="goeoeo">
<meta property="og:url" content="https://phpdi.github.io/page/3/index.html">
<meta property="og:site_name" content="goeoeo">
<meta property="og:description" content="自律给我自由">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Chen Yu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://phpdi.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title> goeoeo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">goeoeo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">会吃鱼</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/08/25/linux/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%92%8C%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/25/linux/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%92%8C%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">linux/常用命令和问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-25 18:27:09" itemprop="dateCreated datePublished" datetime="2021-08-25T18:27:09+08:00">2021-08-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h1><ul>
<li>cat mysql.conf | grep -v “#” | grep -v “^$” 查看未被注释掉的行 </li>
</ul>
<h1 id="生成随机密码"><a href="#生成随机密码" class="headerlink" title="生成随机密码"></a>生成随机密码</h1><p>date +%s |sha256sum |base64 |head -c 10 ;echo</p>
<h1 id="检查端口状态"><a href="#检查端口状态" class="headerlink" title="检查端口状态"></a>检查端口状态</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -Aaln | grep 9090</span><br></pre></td></tr></table></figure>

<h1 id="nohup"><a href="#nohup" class="headerlink" title="nohup"></a>nohup</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup .&#x2F;lwyfront &gt;&#x2F;dev&#x2F;null 2&gt;log &amp;</span><br></pre></td></tr></table></figure>

<h1 id="ubuntu-变更默认执行环境dash-gt-bash"><a href="#ubuntu-变更默认执行环境dash-gt-bash" class="headerlink" title="ubuntu 变更默认执行环境dash =&gt; bash"></a>ubuntu 变更默认执行环境dash =&gt; bash</h1><p>在安装华为seo-client(vpn)时候遇到的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg-reconfigure dash #选否</span><br><span class="line">ll &#x2F;bin&#x2F;sh #查看</span><br></pre></td></tr></table></figure>

<h1 id="sshpass-命令行带密码登录"><a href="#sshpass-命令行带密码登录" class="headerlink" title="sshpass 命令行带密码登录"></a>sshpass 命令行带密码登录</h1><p>配置自定义命令，实现快速登录服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass -p &quot;XXX&quot; ssh user@IP</span><br></pre></td></tr></table></figure>

<h1 id="ubuntu解压windows生成的zip文件时乱码问题"><a href="#ubuntu解压windows生成的zip文件时乱码问题" class="headerlink" title="ubuntu解压windows生成的zip文件时乱码问题"></a>ubuntu解压windows生成的zip文件时乱码问题</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -O CP936 xxx.zip</span><br></pre></td></tr></table></figure>

<h1 id="https-证书生成"><a href="#https-证书生成" class="headerlink" title="https 证书生成"></a>https 证书生成</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openssl req -newkey rsa:4096 \</span><br><span class="line">            -x509 \</span><br><span class="line">            -sha256 \</span><br><span class="line">            -days 3650 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -out example.crt \</span><br><span class="line">            -keyout example.key</span><br></pre></td></tr></table></figure>

<h1 id="ubuntu20-04-频繁卡死重启"><a href="#ubuntu20-04-频繁卡死重启" class="headerlink" title="ubuntu20.04 频繁卡死重启"></a>ubuntu20.04 频繁卡死重启</h1><p>NVIDIA 独立显卡在ubuntu中使用其默认驱动，不兼容，导致频繁死机重启<br>解决办法，为独立显卡安装官方驱动:  </p>
<ol>
<li>ubuntu-drivers devices  #查询驱动<br>选择recommended 推荐驱动<br><img src="/2021/08/25/linux/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%92%8C%E9%97%AE%E9%A2%98/img.png" alt></li>
<li>sudo apt install nvidia-driver-470 #安装驱动  </li>
<li>sudo reboot # 重启  </li>
<li>nvidia-smi # 查看显卡状态  </li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/08/25/mysql/%E9%80%9A%E8%BF%87Docker%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEMySQL%E4%B8%BB%E4%BB%8E%E8%8A%82%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/25/mysql/%E9%80%9A%E8%BF%87Docker%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEMySQL%E4%B8%BB%E4%BB%8E%E8%8A%82%E7%82%B9/" class="post-title-link" itemprop="url">mysql/通过Docker安装配置MySQL主从节点</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-25 18:27:09" itemprop="dateCreated datePublished" datetime="2021-08-25T18:27:09+08:00">2021-08-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="拉取最新版mysql镜像"><a href="#拉取最新版mysql镜像" class="headerlink" title="拉取最新版mysql镜像"></a>拉取最新版mysql镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure>
<h2 id="mysql主服务器"><a href="#mysql主服务器" class="headerlink" title="mysql主服务器"></a>mysql主服务器</h2><h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3307:3306 --name mysql_master -e MYSQL_ROOT_PASSWORD=123456 -d mysql:latest</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/08/25/mysql/%E9%80%9A%E8%BF%87Docker%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEMySQL%E4%B8%BB%E4%BB%8E%E8%8A%82%E7%82%B9/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/08/14/micro/%E5%A4%8D%E6%9D%82%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B9%8B%E9%81%93-%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/14/micro/%E5%A4%8D%E6%9D%82%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B9%8B%E9%81%93-%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">micro/复杂软件设计之道-领域驱动设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-14 23:37:42 / 修改时间：23:48:13" itemprop="dateCreated datePublished" datetime="2021-08-14T23:37:42+08:00">2021-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/micro/" itemprop="url" rel="index">
                    <span itemprop="name">micro</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>复杂软件设计之道-领域驱动设计<br>读书笔记</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/08/14/micro/%E5%A4%8D%E6%9D%82%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B9%8B%E9%81%93-%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/08/06/go/grpc%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%A5%E9%94%99transport%20is%20closing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/06/go/grpc%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%A5%E9%94%99transport%20is%20closing/" class="post-title-link" itemprop="url">go/grpc客户端调用服务端报错transport is closing</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-06 23:08:19" itemprop="dateCreated datePublished" datetime="2021-08-06T23:08:19+08:00">2021-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-07 00:28:12" itemprop="dateModified" datetime="2021-08-07T00:28:12+08:00">2021-08-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="grpc客户端调用服务端报错transport-is-closing"><a href="#grpc客户端调用服务端报错transport-is-closing" class="headerlink" title="grpc客户端调用服务端报错transport is closing"></a>grpc客户端调用服务端报错transport is closing</h1><p>为什么要吧这个错误单独写一篇文章，因为这个问题我debug了3天才解决。</p>
<h2 id="首先说下现象"><a href="#首先说下现象" class="headerlink" title="首先说下现象"></a>首先说下现象</h2><p>测试环境频繁报错，transport is closing，context canceled ，最先没有引起重视，直到导致了数据不一致才决定查这个这个问题。项目中只用了一元调用</p>
<h2 id="grpc-client-和-server-配置"><a href="#grpc-client-和-server-配置" class="headerlink" title="grpc client 和 server 配置"></a>grpc client 和 server 配置</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> BackOffConfig = backoff.Config&#123;</span><br><span class="line">	BaseDelay:  <span class="number">1</span> * time.Second,</span><br><span class="line">	Multiplier: <span class="number">1</span>,</span><br><span class="line">	Jitter:     <span class="number">0.2</span>,</span><br><span class="line">	MaxDelay:   <span class="number">60</span> * time.Second,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> KeepaliveClientConfig = keepalive.ClientParameters&#123;</span><br><span class="line">	Time:                <span class="number">10</span> * time.Second,</span><br><span class="line">	Timeout:             <span class="number">5</span> * time.Minute,</span><br><span class="line">	PermitWithoutStream: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> KeepaliveServerConfig = keepalive.ServerParameters&#123;</span><br><span class="line">	MaxConnectionIdle:     <span class="number">15</span> * time.Second, <span class="comment">// If a client is idle for 10 seconds, send a GOAWAY</span></span><br><span class="line">	MaxConnectionAge:      <span class="number">30</span> * time.Second, <span class="comment">// If any connection is alive for more than 30 seconds, send a GOAWAY</span></span><br><span class="line">	MaxConnectionAgeGrace: <span class="number">5</span> * time.Second,  <span class="comment">// Allow 5 seconds for pending RPCs to complete before forcibly closing connections</span></span><br><span class="line">	Time:    <span class="number">5</span> * time.Second, <span class="comment">// Ping the client if it is idle for 5 seconds to ensure the connection is still active</span></span><br><span class="line">	Timeout: <span class="number">5</span> * time.Minute, <span class="comment">// Wait 1 second for the ping ack before assuming the connection is dead</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> KeepaliveEnforcementPolicy = keepalive.EnforcementPolicy&#123;</span><br><span class="line">	MinTime:             <span class="number">5</span> * time.Second,</span><br><span class="line">	PermitWithoutStream: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置很平常，和grpc-go example相差不远<br>项目中多个客户端共用了grpc conn 由于配置 keepalive 所以是长连接的方式<br>握手过程:<br>grpc client (一元调用)=&gt; k8s service (由kube-proxy通过iptables/ipvs)负载均衡到 =&gt; pod </p>
<blockquote>
<p>这种调用方式会存在流量不均衡，后面再解决</p>
</blockquote>
<p><a href="https://github.com/grpc/grpc-go" target="_blank" rel="noopener">官方</a>解释的这4中情况都不是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1. mis-configured transport credentials, connection failed on handshaking</span><br><span class="line">2. bytes disrupted, possibly by a proxy in between</span><br><span class="line">3. server shutdown</span><br><span class="line">4. Keepalive parameters caused connection shutdown, for example if you have configured your server to terminate connections</span><br><span class="line">regularly to trigger DNS lookups. If this is the case, you may want to increase your MaxConnectionAgeGrace, to allow longer RPC calls to finish.</span><br></pre></td></tr></table></figure>

<h2 id="可能的原因"><a href="#可能的原因" class="headerlink" title="可能的原因"></a>可能的原因</h2><h3 id="并发？"><a href="#并发？" class="headerlink" title="并发？"></a>并发？</h3><p>项目中实际使用是，go 并发接受rabbitmq的消息，然后再用rpc客户端（共享的grpc conn连接）去调用rpc server ,我在本地测试的是否，测过并发的情况<br>并发量在5000的时候没有问题，想着测试环境没有这么高的并发，变没有注意。  </p>
<h3 id="grpc-debug"><a href="#grpc-debug" class="headerlink" title="grpc debug"></a>grpc debug</h3><p>我开启了grpc 调试模式 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export GODEBUG&#x3D;http2debug&#x3D;2</span><br><span class="line">$ export GRPC_GO_LOG_VERBOSITY_LEVEL&#x3D;99</span><br><span class="line">$ export GRPC_GO_LOG_SEVERITY_LEVEL&#x3D;info</span><br></pre></td></tr></table></figure>
<p>观察到每隔15秒，grpc server 会发送一个goaway的数据包到客户端，这是因为上面我们配置的MaxConnectionIdle 为15秒，通知客户端关闭连接。<br>假如client已经发送请求到服务端，服务端请求耗时，在ping timeout 时间以内网络抖动（断网在联网），服务端再响应给客户端是没有问题的，<br>但超过了这个时间，client就会报transport is closing,server 也会报context canceled 。这导致我一直认为是网络抖动的问题。</p>
<h3 id="网络抖动？"><a href="#网络抖动？" class="headerlink" title="网络抖动？"></a>网络抖动？</h3><p>我将grpc client和grpc server 的ping timeout 调成了5分钟，此时还是有很多请求几秒钟就报transport is closing<br>因此排除了网络抖动这种情况。  </p>
<h2 id="翻阅-https-github-com-grpc-grpc-go-的issues"><a href="#翻阅-https-github-com-grpc-grpc-go-的issues" class="headerlink" title="翻阅 https://github.com/grpc/grpc-go 的issues"></a>翻阅 <a href="https://github.com/grpc/grpc-go" target="_blank" rel="noopener">https://github.com/grpc/grpc-go</a> 的issues</h2><p>直到我看到了这个issues:<a href="https://github.com/grpc/grpc-go/issues/3297" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/issues/3297</a><br>问题主描述了，他在单连接情况下遇到的the connection is draining和transport is closing<br>有人回答了他: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">This is caused by a race between the start of a stream on a connection and the graceful close of the connection.</span><br><span class="line">The server sends a GOAWAY when number of requests on the connection reaches the limit. But the client keeps sending new streams on this connection, until it receives the GOAWAY. The steams between server sending GOAWAY and client receiving GOAWAY will fail.</span><br><span class="line"></span><br><span class="line">The gRPC client does a retry for this kind of failures, but retry only happens once (for each RPC).</span><br><span class="line"></span><br><span class="line">How often do the errors happen? And which of the errors (&quot;connection is draining&quot; vs &quot;transport is closing&quot;) happen more often?</span><br><span class="line"></span><br><span class="line">One thing to try is to add grpc.WaitForReady(true) to the RPC.</span><br><span class="line">Another thing to think of is to handle these errors in the application code. This is what will happen when the connection (TCP) is down for whatever reason. The application should be able to handle them (retry, or fail).</span><br></pre></td></tr></table></figure>
<p>意思是由连接上的流开始和连接的正常关闭之间的竞争引起的。 当连接上的请求数达到限制时，服务器发送 GOAWAY。但是客户端不断在这个连接上发送新的流，直到它收到 GOAWAY。服务器发送 GOAWAY 和客户端接收 GOAWAY 之间的流将失败。<br>也就是说如果server发出goaway的时候，此时grpc conn 正在发送流到服务端，这时候会产生一个竞争关系。  </p>
<p>抱着这个想法，我重新实验了我的并发程序，我将并发数量改到10000，transport is closing 出现了。平常的并发并不会触发服务器关闭连接，而是当服务器发送GOAWAY包的时候，客户端还在<br>并发的发送数据,就会导致服务端和客户端的流丢失，从而触发服务端关闭连接，报transport is closing。 </p>
<p>于是我将grpc server的配置改成了这样:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var KeepaliveServerConfig &#x3D; keepalive.ServerParameters&#123;</span><br><span class="line">	Time:    5 * time.Second, &#x2F;&#x2F; Ping the client if it is idle for 5 seconds to ensure the connection is still active</span><br><span class="line">	Timeout: 5 * time.Minute, &#x2F;&#x2F; Wait 1 second for the ping ack before assuming the connection is dead</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本身我们使用的长连接，在项目中不会频繁创建连接。所以这里不用关闭它，其次即使是断网的情况下，在ping timeout 时间内，网络恢复后连接依然可以重用。最坏的情况就是断网连不上了<br>这个连接就交个操作系统去回收吧（本身 tcp 也有keepalive机制）改完上到测试环境，世界安静了，再没有transport is closing</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用k8s service的负载均衡是4层负载均衡，只在握手时起作用，一旦长连接建立，service的负载便没有了作用。解决这个问题需要用grpc 客户端负载均衡进行处理  </li>
<li>在helm upgrade的时候依然会报，这是因为在关闭grpc server 没有调用 GracefulStop() 方法进行平滑停止.  </li>
<li>GOAWAY 是http2协议包，并非grpc独有,http2实现了io多路复用，就是说可以并发的向同一个tcp连接中写数据，消息也不会错乱。  </li>
<li>http2 同一个连接，发送连接数是有限制的，在服务端可以设置（官方并不建议调这个参数），超过这个显示，后面的请求会排队。  </li>
</ol>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a href="https://github.com/grpc/grpc-go/issues/3297" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/issues/3297</a></li>
<li><a href="https://www.jianshu.com/p/ae72ad58ecb6" target="_blank" rel="noopener">Golang信号处理和优雅退出守护进程</a></li>
<li><a href="https://pandaychen.github.io/2020/09/01/GRPC-CLIENT-CONN-LASTING/" target="_blank" rel="noopener">https://pandaychen.github.io/2020/09/01/GRPC-CLIENT-CONN-LASTING/</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1816510" target="_blank" rel="noopener">gRPC的平滑关闭和在Kubernetes上的服务摘流方案总结</a></li>
<li><a href="https://docs.microsoft.com/zh-cn/aspnet/core/grpc/performance?view=aspnetcore-5.0#reuse-grpc-channels" target="_blank" rel="noopener">GRPC 性能最佳做法</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/07/19/k8s/k8s%E8%B8%A9%E5%9D%91%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/19/k8s/k8s%E8%B8%A9%E5%9D%91%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">k8s/k8s踩坑日志</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-19 10:54:32" itemprop="dateCreated datePublished" datetime="2021-07-19T10:54:32+08:00">2021-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-21 16:31:43" itemprop="dateModified" datetime="2021-07-21T16:31:43+08:00">2021-07-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pvc挂载不上pv"><a href="#pvc挂载不上pv" class="headerlink" title="pvc挂载不上pv"></a>pvc挂载不上pv</h1><ul>
<li>annotations 不一致会影响pvc的挂载</li>
</ul>
<h1 id="通过coredns-访问mysql-beatflow-data-svc和mysql-beatflow-data-svc-cluster-local-，有些时候在不同命名空间下可能访问不到"><a href="#通过coredns-访问mysql-beatflow-data-svc和mysql-beatflow-data-svc-cluster-local-，有些时候在不同命名空间下可能访问不到" class="headerlink" title="通过coredns 访问mysql.beatflow-data.svc和mysql.beatflow-data.svc.cluster.local ，有些时候在不同命名空间下可能访问不到"></a>通过coredns 访问mysql.beatflow-data.svc和mysql.beatflow-data.svc.cluster.local ，有些时候在不同命名空间下可能访问不到</h1><h1 id="coredns-debug"><a href="#coredns-debug" class="headerlink" title="coredns debug"></a>coredns debug</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl run dig --rm -it --image&#x3D;docker.io&#x2F;azukiapp&#x2F;dig &#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F; # nslookup kubernetes.default</span><br><span class="line">Server:		10.96.0.10</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"></span><br><span class="line">Name:	kubernetes.default.svc.cluster.local</span><br><span class="line">Address: 10.96.0.1</span><br></pre></td></tr></table></figure>

<h1 id="在kubeSphere-管理的k8s集群上搭建使用Prometheus-Operator-helm安装prometheus-起不来"><a href="#在kubeSphere-管理的k8s集群上搭建使用Prometheus-Operator-helm安装prometheus-起不来" class="headerlink" title="在kubeSphere 管理的k8s集群上搭建使用Prometheus Operator helm安装prometheus 起不来"></a>在kubeSphere 管理的k8s集群上搭建使用Prometheus Operator helm安装prometheus 起不来</h1><ul>
<li>kubeSphere 已经安装了prometheus ,并且每个节点已经装了node-exporter所以导致起不来</li>
<li>目前我们只需要安装grafana就可以了</li>
<li>Prometheus Operator 通过service monitor 添加监控节点。</li>
</ul>
<h1 id="k8s服务中headless-和-Cluster-IP-区别，使用headless会导致pod访问延迟"><a href="#k8s服务中headless-和-Cluster-IP-区别，使用headless会导致pod访问延迟" class="headerlink" title="k8s服务中headless 和 Cluster IP 区别，使用headless会导致pod访问延迟"></a>k8s服务中headless 和 Cluster IP 区别，使用headless会导致pod访问延迟</h1><p>headless 模式通过CoreDNS 解析到pod上面不走service的负载均衡<br>因为通过coredns ，pod起来后，并不能立即访问到会有延迟<br>clusterIp 模式，访问service 的clusterIp 再通过iptables 转发到pod上面，pod起来后可以直接访问，不会有延迟。  </p>
<h1 id="minikube-在使用ntf-报错-does-not-support-NFS-export"><a href="#minikube-在使用ntf-报错-does-not-support-NFS-export" class="headerlink" title="minikube 在使用ntf 报错  does not support NFS export"></a>minikube 在使用ntf 报错  does not support NFS export</h1><p>挂载 /nfs 报错 does not support NFS export<br>解决: 挂载 /data/nfs<br>minikube 在driver 为docker的模式下面 只能挂载到/data目录下面去，其他目录都会报错</p>
<h1 id="helm-安装报错"><a href="#helm-安装报错" class="headerlink" title="helm 安装报错"></a>helm 安装报错</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: Kubernetes cluster unreachable: Get &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;version?timeout&#x3D;32s&quot;: dial tcp 127.0.0.1:8080: connect: connection refused</span><br></pre></td></tr></table></figure>
<p>报错原因: helm v3版本不再需要Tiller，而是直接访问ApiServer来与k8s交互，通过环境变量KUBECONFIG来读取存有ApiServre的地址与token的配置文件地址，默认地址为<del>/.kube/config<br>export KUBECONFIG=</del>/.kube/config  </p>
<h1 id="minikube-服务端口映射到主机"><a href="#minikube-服务端口映射到主机" class="headerlink" title="minikube 服务端口映射到主机"></a>minikube 服务端口映射到主机</h1><p>场景: 需要外网访问minikube集群中的服务  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward svc&#x2F;mysql 30001:3306 -n beatflow-data --address 0.0.0.0</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/07/15/go/goland%E6%BF%80%E6%B4%BB%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/15/go/goland%E6%BF%80%E6%B4%BB%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">go/goland激活教程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-15 11:12:45" itemprop="dateCreated datePublished" datetime="2021-07-15T11:12:45+08:00">2021-07-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>提供三种方式进行激活</p>
<h2 id="申请使用License（推荐）"><a href="#申请使用License（推荐）" class="headerlink" title="申请使用License（推荐）"></a>申请使用License（推荐）</h2><p>转载自<a href="https://www.toutiao.com/a6744540170936123916/" target="_blank" rel="noopener">免费获取 JetBrains 全系产品正版 License</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/07/15/go/goland%E6%BF%80%E6%B4%BB%E6%95%99%E7%A8%8B/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/07/15/k8s/minikube/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/15/k8s/minikube/" class="post-title-link" itemprop="url">k8s/minikube</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-15 11:12:45" itemprop="dateCreated datePublished" datetime="2021-07-15T11:12:45+08:00">2021-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-22 16:08:03" itemprop="dateModified" datetime="2021-07-22T16:08:03+08:00">2021-07-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <a id="more"></a>


<h1 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h1><p>minikube 可以搭建一个在单节点运行的k8s集群  </p>
<p>使用minikube 构建k8s本地化开发环境</p>
<!--more-->

<h2 id="Minikube安装"><a href="#Minikube安装" class="headerlink" title="Minikube安装"></a>Minikube安装</h2><p>首先我们需要下载Minikube的二进制安装包并安装:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https:&#x2F;&#x2F;storage.googleapis.com&#x2F;minikube&#x2F;releases&#x2F;latest&#x2F;minikube-linux-amd64</span><br><span class="line">sudo install minikube-linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;minikube</span><br></pre></td></tr></table></figure>
<h2 id="Minikube启动"><a href="#Minikube启动" class="headerlink" title="Minikube启动"></a>Minikube启动</h2><p>需要使用非root 启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">minikube start</span><br><span class="line"></span><br><span class="line"># 信任私有仓库 注意如果已经 minikube start 过了，那么需要删除集群重新启动 minikube delete ,这个参数才会生效</span><br><span class="line">minikube start --insecure-registry&#x3D;repo.goeoeo.com:8100</span><br></pre></td></tr></table></figure>

<h2 id="安装kubectl"><a href="#安装kubectl" class="headerlink" title="安装kubectl"></a>安装kubectl</h2><p>查看kubectl的版本号，第一次使用会直接安装kubectl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube kubectl version</span><br></pre></td></tr></table></figure>
<p>想直接使用kubectl命令的话，可以将其复制到/bin目录下去：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 查找kubectl命令的位置</span><br><span class="line">find &#x2F; -name kubectl</span><br><span class="line"># 找到之后复制到&#x2F;bin目录下</span><br><span class="line">cp &#x2F;mydata&#x2F;docker&#x2F;volumes&#x2F;minikube&#x2F;_data&#x2F;lib&#x2F;minikube&#x2F;binaries&#x2F;v1.20.0&#x2F;kubectl &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br><span class="line"># 直接使用kubectl命令</span><br><span class="line">kubectl version</span><br></pre></td></tr></table></figure>

<h2 id="构建本地镜像"><a href="#构建本地镜像" class="headerlink" title="构建本地镜像"></a>构建本地镜像</h2><p>使用与Minikube VM相同的Docker主机构建镜像，以使镜像自动存在。为此，请确保使用Minikube Docker守护进程：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval $(minikube docker-env)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果不在使用Minikube主机时，可以通过运行eval $(minikube docker-env -u)来撤消此更改。</p>
</blockquote>
<p>使用Minikube Docker守护进程build Docker镜像：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t hello-node:v1 .</span><br></pre></td></tr></table></figure>

<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run hello-node --image&#x3D;hello-node:v1 --port&#x3D;8080</span><br></pre></td></tr></table></figure>

<p>这里有个坑 ,我打tag的时候打成的latest，一直报找不到镜像，原因是如果省略imagePullPolicy 镜像tag为 :latest 策略为always ，否则 策略为 IfNotPresent</p>
<h2 id="minikube-端口转发至本地"><a href="#minikube-端口转发至本地" class="headerlink" title="minikube 端口转发至本地"></a>minikube 端口转发至本地</h2><p>这实际上是k8s的功能  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward svc&#x2F;mysql 32316:3306 -n beatflow-data --address 0.0.0.0  </span><br><span class="line"></span><br><span class="line">#端口转发要注意，helm install重新安装后，要kill掉当前的端口转发进程，再重新的进行转发一次才能生效，但是helm upgrade是无影响的</span><br></pre></td></tr></table></figure>
<blockquote>
<p>kubectl proxy 只能转发http请求</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.toutiao.com/i6918983713418166788/?tt_from=weixin&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;timestamp=1622183070&amp;app=news_article&amp;utm_source=weixin&amp;utm_medium=toutiao_android&amp;use_new_style=1&amp;req_id=202105281424300101350990833D07A87F&amp;share_token=c2146953-602c-452f-9329-67054429477a&amp;group_id=6918983713418166788" target="_blank" rel="noopener">https://www.toutiao.com/i6918983713418166788/?tt_from=weixin&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;timestamp=1622183070&amp;app=news_article&amp;utm_source=weixin&amp;utm_medium=toutiao_android&amp;use_new_style=1&amp;req_id=202105281424300101350990833D07A87F&amp;share_token=c2146953-602c-452f-9329-67054429477a&amp;group_id=6918983713418166788</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/07/12/rabbitmq/rabbitmq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/12/rabbitmq/rabbitmq/" class="post-title-link" itemprop="url">rabbitmq/rabbitmq</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-12 11:49:34 / 修改时间：14:49:33" itemprop="dateCreated datePublished" datetime="2021-07-12T11:49:34+08:00">2021-07-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mq/" itemprop="url" rel="index">
                    <span itemprop="name">mq</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <a id="more"></a>


<h2 id="消息队列协议"><a href="#消息队列协议" class="headerlink" title="消息队列协议"></a>消息队列协议</h2><p>传递、存储、分发  </p>
<h3 id="面试题：为什么消息中间件不直接使用http协议。"><a href="#面试题：为什么消息中间件不直接使用http协议。" class="headerlink" title="面试题：为什么消息中间件不直接使用http协议。"></a>面试题：为什么消息中间件不直接使用http协议。</h3><p>1.http协议请求报文头和响应报文头是比较复杂的，包含了消息传递不需要的部分。<br>2.http大部分是短连接，一个请求到响应很可能会中断，中断以后就不会持久化，消息中间件可能是一个长期的获取消息的过程，出现问题和故障要对数据或消息持久化。  </p>
<h3 id="常见消息中间件协议"><a href="#常见消息中间件协议" class="headerlink" title="常见消息中间件协议"></a>常见消息中间件协议</h3><p>AMQP、MQTT、Kafka、OpenMessage</p>
<h4 id="AMQP"><a href="#AMQP" class="headerlink" title="AMQP"></a>AMQP</h4><p>Erlang语言开发，默认端口5672<br>产品支持：rabbmitmq acitvemq  </p>
<ul>
<li>分布式事务支持</li>
<li>消息的持久化支持</li>
<li>高性能和高可靠的消息处理优势<h4 id="MQTT协议"><a href="#MQTT协议" class="headerlink" title="MQTT协议"></a>MQTT协议</h4>MQTT协议是IBM开放的一个即时通讯协议，物联网系统架构中重要组成部分<br>产品支持：rabbmitmq acitvemq  </li>
</ul>
<p>特点  </p>
<ol>
<li>轻量  </li>
<li>结构简单  </li>
<li>传输快、不支持事务  </li>
<li>没有持久化设计。<br>应用场景：   </li>
<li>适用于计算能力有限   </li>
<li>低带宽 </li>
<li>网络不稳地的场景  </li>
</ol>
<h4 id="OpenMessage"><a href="#OpenMessage" class="headerlink" title="OpenMessage"></a>OpenMessage</h4><p>由阿里、雅虎、滴滴等共同参与创立的分布式消息中间件（布道者保持中立态度。。。）</p>
<ol>
<li>结构简单  </li>
<li>解析速度快  </li>
<li>支持事务和持久化  </li>
</ol>
<p>产品支持：rocketmq  </p>
<h4 id="kafka协议"><a href="#kafka协议" class="headerlink" title="kafka协议"></a>kafka协议</h4><p>kafka协议是基于TCP/IP的二进制协议，消息内部是通过长度分割，由一些基本的数据类型组成<br>特点是：  </p>
<ol>
<li>结构简单  </li>
<li>解析速度快  </li>
<li>无事务支持  </li>
<li>有持久化设计  </li>
</ol>
<h2 id="消息持久化"><a href="#消息持久化" class="headerlink" title="消息持久化"></a>消息持久化</h2><p>将数据存入磁盘中</p>
<h2 id="消息的分发策略"><a href="#消息的分发策略" class="headerlink" title="消息的分发策略"></a>消息的分发策略</h2><p>消息队列MQ是一种推送的过程。  </p>
<h3 id="消息分发策略的机制和对比"><a href="#消息分发策略的机制和对比" class="headerlink" title="消息分发策略的机制和对比"></a>消息分发策略的机制和对比</h3><p>||ActiveMQ|RabbitMQ|Kafka|RocketMQ|<br>||:—:|:—:|:—:|:—:|<br>|发布订阅|支持|支持|支持|支持|<br>|轮询分发|支持|支持|支持|/|<br>|公平分发|/|支持|支持|/|<br>|重发|支持|支持|/|支持|<br>|消息拉取|/|支持|支持|支持|</p>
<blockquote>
<p>轮询分发，消费分发数量是均匀的。<br>公平分发会根据服务器的性能分发消息，会造成消息的倾斜。rabbitmq 使用公平分发需要使用手动确认的方式。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/06/29/k8s/helm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/29/k8s/helm/" class="post-title-link" itemprop="url">k8s/helm</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-29 13:44:09" itemprop="dateCreated datePublished" datetime="2021-06-29T13:44:09+08:00">2021-06-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h1><p>Helm 是 Kubernetes 的包管理器。包管理器类似于我们在 Ubuntu 中使用的apt、Centos中使用的yum 或者Python中的 pip 一样，能快速查找、下载和安装软件包<br>官网:<a href="https://helm.sh/" target="_blank" rel="noopener">https://helm.sh/</a><br>官方文档地址: <a href="https://helm.sh/zh/docs" target="_blank" rel="noopener">https://helm.sh/zh/docs</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/06/29/k8s/helm/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phpdi.github.io/2021/06/04/k8s/harbor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpeg">
      <meta itemprop="name" content="Chen Yu">
      <meta itemprop="description" content="自律给我自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goeoeo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/k8s/harbor/" class="post-title-link" itemprop="url">k8s/harbor</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-04 14:01:54" itemprop="dateCreated datePublished" datetime="2021-06-04T14:01:54+08:00">2021-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-04 08:55:22" itemprop="dateModified" datetime="2021-08-04T08:55:22+08:00">2021-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <a id="more"></a>

<h1 id="harbor"><a href="#harbor" class="headerlink" title="harbor"></a>harbor</h1><p>VMware开源的企业级Registry项目Harbor，以Docker公司开源的registry 为基础，提供了管理UI, 基于角色的访问控制(Role Based Access Control)，AD/LDAP集成、以及审计日志(Audit logging) 等企业用户需求的功能，同时还原生支持中文，主要特点：</p>
<p>基于角色的访问控制 - 用户与 Docker 镜像仓库通过“项目”进行组织管理，一个用户可以对多个镜像仓库在同一命名空间（project）里有不同的权限。</p>
<p>镜像复制 - 镜像可以在多个 Registry 实例中复制（同步）。尤其适合于负载均衡，高可用，混合云和多云的场景。</p>
<p>图形化用户界面 - 用户可以通过浏览器来浏览，检索当前 Docker 镜像仓库，管理项目和命名空间。</p>
<p>AD/LDAP 支持 - Harbor 可以集成企业内部已有的 AD/LDAP，用于鉴权认证管理。</p>
<p>审计管理 - 所有针对镜像仓库的操作都可以被记录追溯，用于审计管理。</p>
<p>国际化 - 已拥有英文、中文、德文、日文和俄文的本地化版本。更多的语言将会添加进来。</p>
<p>RESTful API - RESTful API 提供给管理员对于 Harbor 更多的操控, 使得与其它管理软件集成变得更容易。</p>
<p>部署简单 - 提供在线和离线两种安装工具， 也可以安装到 vSphere 平台(OVA 方式)虚拟设备</p>
<!--more-->

<h1 id="harbor架构"><a href="#harbor架构" class="headerlink" title="harbor架构"></a>harbor架构</h1><p>默认情况下，Harbor运行起来后有如下容器：<br><img src="/2021/06/04/k8s/harbor/2021-06-04_14-05.png" alt></p>
<p>名称分别为：nginx、harbor-jobservice、harbor-ui、harbor-db、harbor-adminserver、registry以及harbor-log。<br><img src="/2021/06/04/k8s/harbor/1201528-20200712102731871-1271938765.png" alt></p>
<p>如上图所描述，Harbor由6个大的模块所组成：  </p>
<ul>
<li>Proxy: Harbor的registry、UI、token services等组件，都处在一个反向代理后边。该代理将来自浏览器、docker clients的请求转发到后端服务上。</li>
<li>Registry: 负责存储Docker镜像，以及处理Docker push/pull请求。因为Harbor强制要求对镜像的访问做权限控制， 在每一次push/pull请求时，Registry会强制要求客户端从token service那里获得一个有效的token。</li>
<li>Core services: Harbor的核心功能，主要包括如下3个服务:<br>1）UI: 作为Registry Webhook, 以图像用户界面的方式辅助用户管理镜像。<br>2) WebHook：WebHook是在registry中配置的一种机制， 当registry中镜像发生改变时，就可以通知到Harbor的webhook endpoint。Harbor使用webhook来更新日志、初始化同步job等。<br>3) Token 服务：负责根据用户权限给每个docker push/pull命令签发token. Docker 客户端向Regiøstry服务发起的请求,如果不包含token，会被重定向到这里，获得token后再重新向Registry进行请求。</li>
<li>Database：为core services提供数据库服务，负责储存用户权限、审计日志、Docker image分组信息等数据。</li>
<li>Job services: 主要用于镜像复制，本地镜像可以被同步到远程Harbor实例上。</li>
<li>Log collector: 负责收集其他组件的日志到一个地方 </li>
</ul>
<p>这里我们与上面运行的7个容器对比，对harbor-adminserver感觉有些疑虑。其实这里harbor-adminserver主要是作为一个后端的配置数据管理，并没有太多的其他功能。harbor-ui所要操作的所有数据都通过harbor-adminserver这样一个数据配置管理中心来完成。  </p>
<h1 id="Harbor实现"><a href="#Harbor实现" class="headerlink" title="Harbor实现"></a>Harbor实现</h1><p>Harbor的每一个组件都被包装成一个docker容器。自然，Harbor是通过docker compose来部署的。在Harbor源代码的make目录下的docker-compose模板会被用于部署Harbor。打开该模板文件，可以看到Harbor由7个容器组件所组成：  </p>
<ul>
<li>proxy: 通过nginx服务器来做反向代理</li>
<li>registry: docker官方发布的一个仓库镜像组件</li>
<li>ui: 整个架构的核心服务。该容器是Harbor工程的主要部分</li>
<li>adminserver: 作为Harbor工程的配置数据管理器使用</li>
<li>mysql: 通过官方Mysql镜像创建的数据库容器</li>
<li>job services: 通过状态机的形式将镜像复制到远程Harbor实例。镜像删除同样也可以被同步到远程Harbor实例中。</li>
<li>log: 运行rsyslogd的容器，主要用于收集其他容器的日志</li>
</ul>
<p>这些容器之间都通过Docker内的DNS服务发现来连接通信。通过这种方式，每一个容器都可以通过相应的容器来进行访问。对于终端用户来说，只有反向代理(Nginx)服务的端口需要对外暴露。</p>
<h1 id="harbor部署"><a href="#harbor部署" class="headerlink" title="harbor部署"></a>harbor部署</h1><p>依赖docker  docker-compose</p>
<h2 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h2><p><a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a> </p>
<h2 id="解压harbor离线版安装包"><a href="#解压harbor离线版安装包" class="headerlink" title="解压harbor离线版安装包"></a>解压harbor离线版安装包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf harbor-offline-installer-v2.2.2.tgz </span><br><span class="line"></span><br><span class="line">mv harbor ~&#x2F;harbor</span><br><span class="line">cd ~&#x2F;harbor</span><br></pre></td></tr></table></figure>

<h2 id="修改harbor安装的配置文件"><a href="#修改harbor安装的配置文件" class="headerlink" title="修改harbor安装的配置文件"></a>修改harbor安装的配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cp harbor.yml.tmpl  harbor.yml</span><br><span class="line"># 挂载地址</span><br><span class="line">mkdir data </span><br><span class="line"># 域名</span><br><span class="line">echo 172.16.4.171 repo.goeoeo.com &gt;&gt; &#x2F;etc&#x2F;hosts</span><br><span class="line"></span><br><span class="line">harbor.yml配置文件主要修改参数如下：</span><br><span class="line">hostname: repo.goeoeo.com          &#x2F;&#x2F;需要写IP地址或者域名</span><br><span class="line">#http配置</span><br><span class="line">http:</span><br><span class="line"># port for http, default is 80. If https enabled, this port will redirect to https port</span><br><span class="line">port: 80                       </span><br><span class="line"></span><br><span class="line">#https配置（如不需要可不配置,本地开发我全部注释了）</span><br><span class="line"></span><br><span class="line"># https related config</span><br><span class="line">#https:</span><br><span class="line"># https port for harbor, default is 443</span><br><span class="line"># port: 443</span><br><span class="line"># The path of cert and key files for nginx</span><br><span class="line"># certificate: &#x2F;your&#x2F;certificate&#x2F;path</span><br><span class="line"># private_key: &#x2F;your&#x2F;private&#x2F;key&#x2F;path</span><br><span class="line"></span><br><span class="line">harbor_admin_password: Harbor12345         &#x2F;&#x2F;admin密码</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#数据库配置</span><br><span class="line">database:</span><br><span class="line"># The password for the root user of Harbor DB. Change this before any production use.</span><br><span class="line">password: root123</span><br><span class="line"># The maximum number of connections in the idle connection pool. If it &lt;&#x3D;0, no idle connections are retained.</span><br><span class="line">max_idle_conns: 50</span><br><span class="line"># The maximum number of open connections to the database. If it &lt;&#x3D; 0, then there is no limit on the number of open connections.</span><br><span class="line"># Note: the default number of connections is 100 for postgres.</span><br><span class="line">max_open_conns: 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#持久化数据目录</span><br><span class="line">data_volume: &#x2F;home&#x2F;yu&#x2F;harbor&#x2F;data</span><br></pre></td></tr></table></figure>

<h2 id="安装并启动Harbor"><a href="#安装并启动Harbor" class="headerlink" title="安装并启动Harbor"></a>安装并启动Harbor</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;install.sh</span><br></pre></td></tr></table></figure>

<h2 id="访问harbor-WEB界面"><a href="#访问harbor-WEB界面" class="headerlink" title="访问harbor WEB界面"></a>访问harbor WEB界面</h2><p><a href="http://repo.goeoeo.com" target="_blank" rel="noopener">http://repo.goeoeo.com</a>     admin    Harbor12345</p>
<h1 id="Harbor的使用（上传下载镜像）"><a href="#Harbor的使用（上传下载镜像）" class="headerlink" title="Harbor的使用（上传下载镜像）"></a>Harbor的使用（上传下载镜像）</h1><h2 id="登录harbor"><a href="#登录harbor" class="headerlink" title="登录harbor"></a>登录harbor</h2><p>防止登录失败，我没开https,修改/etc/docker/daemon.json </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo echo &#x2F;etc&#x2F;docker&#x2F;daemon.json&lt;&lt;DATA</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;9lrfffi7.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;insecure-registries&quot;:[&quot;repo.goeoeo.com&quot;,&quot;10.245.20.7:1888&quot;]</span><br><span class="line">&#125;</span><br><span class="line">DATA</span><br><span class="line"></span><br><span class="line">sudo systemctl restart docker.service</span><br><span class="line"></span><br><span class="line"># 登录</span><br><span class="line">docker login -u admin -p Harbor12345 repo.goeoeo.com:8100</span><br><span class="line">docker login -u admin -p Harbor12345 172.31.164.128</span><br><span class="line">docker login -u admin -p Harbor12345 10.245.20.7:1888</span><br><span class="line">docker login -u admin -p Harbor12345 dockerhub.qingcloud.com:1880</span><br></pre></td></tr></table></figure>
<h2 id="在Harbor上创建新项目供上传使用"><a href="#在Harbor上创建新项目供上传使用" class="headerlink" title="在Harbor上创建新项目供上传使用"></a>在Harbor上创建新项目供上传使用</h2><p>我创建了新项目 newbilling<br><img src="/2021/06/04/k8s/harbor/2021-06-04_14-59.png" alt></p>
<h2 id="构建镜像推送"><a href="#构建镜像推送" class="headerlink" title="构建镜像推送"></a>构建镜像推送</h2><p>镜像名称需要注意 为 repo.goeoeo.com/newbilling/&lt;镜像名&gt; 的这种格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 构建</span><br><span class="line">docker build -t repo.goeoeo.com&#x2F;newbilling&#x2F;api-gateway:v1 .</span><br><span class="line"></span><br><span class="line"># 推送</span><br><span class="line">docker push repo.goeoeo.com&#x2F;newbilling&#x2F;api-gateway:v1</span><br></pre></td></tr></table></figure>
<h2 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker rmi repo.goeoeo.com&#x2F;newbilling&#x2F;api-gateway:v1</span><br><span class="line"></span><br><span class="line">docker pull repo.goeoeo.com&#x2F;newbilling&#x2F;api-gateway:v1</span><br></pre></td></tr></table></figure>

<h2 id="Harbor如何停止与启动"><a href="#Harbor如何停止与启动" class="headerlink" title="Harbor如何停止与启动"></a>Harbor如何停止与启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;yu&#x2F;harbor</span><br><span class="line">.&#x2F;install.sh    &#x2F;&#x2F;停止Harbor</span><br><span class="line">docker-compose up -d   &#x2F;&#x2F;启动Harbor</span><br></pre></td></tr></table></figure>


<h2 id="helm-添加harbor仓库。"><a href="#helm-添加harbor仓库。" class="headerlink" title="helm 添加harbor仓库。"></a>helm 添加harbor仓库。</h2><p>arbor安装的时候默认没有helm charts的仓库，启用 harbor 的 chart repository 服务  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br><span class="line">.&#x2F;install.sh  --with-chartmuseum</span><br></pre></td></tr></table></figure>
<p>helm 添加仓库  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add goeoeo --username admin --password&#x3D;Harbor12345  http:&#x2F;&#x2F;repo.goeoeo.com:8100&#x2F;chartrepo</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chen Yu"
      src="/images/head.jpeg">
  <p class="site-author-name" itemprop="name">Chen Yu</p>
  <div class="site-description" itemprop="description">自律给我自由</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chen Yu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.0
  </div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
